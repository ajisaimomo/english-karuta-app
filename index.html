<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>まなびの窓口 📚✨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'BIZ UDPゴシック', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            text-align: center;
            color: #5a67d8;
            font-size: 2.8em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            margin-bottom: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 15px;
            background: linear-gradient(145deg, #f8f9ff 0%, #e8f4f8 100%);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.5em;
            color: #4a5568;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: stretch;
        }
        
        input[type="text"],         textarea {
            flex: 1;
            padding: 20px;
            font-size: 16px;
            line-height: 1.8;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            resize: vertical;
            transition: border-color 0.3s ease;
            font-family: inherit;
            min-height: 150px;
        }
        
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #fc8181, #f56565);
        }
        
        .btn-copy {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
        }
        
        .btn-voice {
            background: linear-gradient(45deg, #9f7aea, #805ad5);
            min-width: 50px;
            justify-content: center;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .result-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            min-height: 80px;
            font-size: 18px;
            line-height: 2;
            display: none;
        }
        
        .result-success {
            border-color: #68d391;
            background: linear-gradient(145deg, #f0fff4 0%, #c6f6d5 100%);
        }
        
        .result-error {
            border-color: #fc8181;
            background: linear-gradient(145deg, #fffafa 0%, #fed7d7 100%);
            color: #c53030;
        }
        
        .result-loading {
            border-color: #b794f6;
            background: linear-gradient(145deg, #faf5ff 0%, #e9d8fd 100%);
            color: #553c9a;
        }
        
        ruby rt {
            font-size: 14px;
            color: #666;
            font-weight: normal;
        }
        
        .stats {
            background: #edf2f7;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }
        
        .copy-success {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: copyNotification 4s ease-out;
        }
        
        @keyframes copyNotification {
            0% { opacity: 0; transform: translateX(100px); }
            10% { opacity: 1; transform: translateX(0); }
            90% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100px); }
        }
        
        @media (max-width: 768px) {
            .container { padding: 20px; margin: 10px; }
            h1 { font-size: 2.2em; }
            .input-group { flex-direction: column; }
            .btn { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>まなびの窓口 📚✨</h1>
        <p class="subtitle">Google<ruby>検索<rt>けんさく</rt></ruby> + <ruby>辞書<rt>じしょ</rt></ruby> + ルビ<ruby>振<rt>ふ</rt></ruby>りが1つのサイトで<ruby>完結<rt>かんけつ</rt></ruby></p>
        
        <!-- 1. Google検索セクション -->
        <div class="section">
            <h2 class="section-title">
                <span>🔍</span>
                Google検索（音声入力対応）
            </h2>
            <div class="input-group">
                <input type="text" id="searchInput" placeholder="調べたいことを入力してください（例：人工知能、歴史、科学など）">
                <button class="btn btn-voice" onclick="startVoiceSearch()" id="voiceBtn" title="音声入力">
                    🎤
                </button>
                <button class="btn" onclick="googleSearch()">
                    <span>🔍</span> 検索
                </button>
            </div>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">
                💡 検索結果は新しいタブで開きます。結果をコピーして下の「ルビ振り」で使えます。
            </p>
        </div>
        
        <!-- 2. 辞書セクション -->
        <div class="section">
            <h2 class="section-title">
                <span>📖</span>
                単語の意味調べ（2つの方法）
            </h2>
            <div class="input-group">
                <input type="text" id="dictInput" placeholder="意味を知りたい単語を入力してください（例：人工知能、十二単など）">
                <button class="btn" onclick="searchGakken()" title="学研キッズ辞書で調べる">
                    <span>🏫</span> 学研辞書
                </button>
                <button class="btn btn-secondary" onclick="searchWithAI()" title="AI要約で意味を調べる">
                    <span>🤖</span> AI要約
                </button>
                <button class="btn btn-danger" onclick="clearDict()">
                    <span>🗑️</span> 消去
                </button>
            </div>
            <div id="dictResult" class="result-box"></div>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">
                💡 <strong>学研辞書</strong>：子ども向け辞書（新しいタブで開きます）<br>
                💡 <strong>AI要約</strong>：Google検索結果をAIが要約してルビ付きで表示
            </p>
        </div>
        
        <!-- 3. ルビ振りセクション -->
        <div class="section">
            <h2 class="section-title">
                <span>✨</span>
                文章にルビ振り（Word貼り付け対応）
            </h2>
            <div class="input-group">
                <textarea id="rubyInput" rows="8" placeholder="ここに文章をコピー＆ペーストしてください。Google検索の結果、ニュース記事、教科書の内容、論文の一部など、どんな文章でも大丈夫です。最大2000文字まで処理できます。" style="flex: 1; min-height: 200px; resize: vertical;"></textarea>
            </div>
            <div class="button-group" style="margin-top: 15px;">
                <button class="btn" onclick="addRuby()" id="rubyBtn">
                    <span>✨</span> ルビを付ける
                </button>
                <button class="btn btn-danger" onclick="clearRuby()">
                    <span>🗑️</span> 消去
                </button>
                <button class="btn btn-copy" onclick="copyResult()" id="copyBtn" style="display: none;">
                    <span>📋</span> 結果をコピー
                </button>
            </div>
            <div id="rubyResult" class="result-box"></div>
        </div>
    </div>

    <script>
        let currentRubyResult = '';
        let currentDictResult = '';
        
        // 1. Google検索機能
        function googleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('検索したい内容を入力してください');
                return;
            }
            
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            window.open(searchUrl, '_blank');
            console.log(`🔍 Google検索: "${query}"`);
        }
        
        // 音声入力機能（エラーハンドリング強化版）
        function startVoiceSearch() {
            // ブラウザ対応チェック
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('❌ お使いのブラウザは音声認識に対応していません\n\n対応ブラウザ:\n・Google Chrome\n・Microsoft Edge\n・Safari（一部）');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'ja-JP';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            const voiceBtn = document.getElementById('voiceBtn');
            const searchInput = document.getElementById('searchInput');
            
            recognition.onstart = () => {
                voiceBtn.style.background = 'linear-gradient(45deg, #fc8181, #f56565)';
                voiceBtn.innerHTML = '🔴';
                console.log('🎤 音声認識開始');
            };
            
            recognition.onresult = (event) => {
                const result = event.results[0][0].transcript;
                searchInput.value = result;
                console.log(`🎤 音声認識結果: "${result}"`);
                
                // 成功メッセージ
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 9999;
                    background: #48bb78; color: white; padding: 15px 20px;
                    border-radius: 10px; font-weight: bold;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                notification.textContent = `🎤 音声認識成功: "${result}"`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 3000);
            };
            
            recognition.onend = () => {
                voiceBtn.style.background = 'linear-gradient(45deg, #9f7aea, #805ad5)';
                voiceBtn.innerHTML = '🎤';
                console.log('🎤 音声認識終了');
            };
            
            recognition.onerror = (event) => {
                console.error('音声認識エラー:', event.error);
                voiceBtn.style.background = 'linear-gradient(45deg, #9f7aea, #805ad5)';
                voiceBtn.innerHTML = '🎤';
                
                let errorMessage = '';
                switch(event.error) {
                    case 'not-allowed':
                        errorMessage = `🎤 マイクへのアクセスが拒否されました

解決方法:
1. ブラウザのアドレスバー左側のマイクアイコンをクリック
2. 「許可」を選択
3. ページを再読み込み

または:
• Chrome: 設定 → プライバシーとセキュリティ → サイト設定 → マイク
• Edge: 設定 → Cookieとサイト権限 → マイク
で、このサイトを許可してください`;
                        break;
                    case 'no-speech':
                        errorMessage = '🎤 音声が検出されませんでした。もう一度お試しください。';
                        break;
                    case 'network':
                        errorMessage = '🎤 ネットワークエラーが発生しました。インターネット接続を確認してください。';
                        break;
                    default:
                        errorMessage = `🎤 音声認識エラー: ${event.error}`;
                }
                
                alert(errorMessage);
            };
            
            try {
                recognition.start();
            } catch (error) {
                console.error('音声認識開始エラー:', error);
                alert('🎤 音声認識を開始できませんでした。ブラウザがマイクアクセスをブロックしている可能性があります。');
            }
        }
        
        // 2. 辞書機能
        // 学研キッズ辞書で検索（修正版 - 正しいURL使用）
        function searchGakken() {
            const word = document.getElementById('dictInput').value.trim();
            if (!word) {
                alert('調べたい単語を入力してください');
                return;
            }
            
            // HTMLから判明した正しい検索URL
            const gakkenUrl = `https://kids.gakken.co.jp/jiten/result/?s=${encodeURIComponent(word)}`;
            window.open(gakkenUrl, '_blank');
            
            // 結果表示
            const resultDiv = document.getElementById('dictResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box result-success';
            resultDiv.innerHTML = `
                <div style="padding: 20px;">
                    <div style="font-size: 1.2em; margin-bottom: 15px; color: #2d3748;">
                        🏫 学研キッズ辞書で「${word}」を検索中...
                    </div>
                    <div style="background: #e6fffa; padding: 15px; border-radius: 8px; border: 1px solid #4fd1c7;">
                        <strong>✅ 検索が開始されました！</strong><br>
                        新しいタブで学研キッズ辞書の検索結果が表示されます。<br>
                        子ども向けの分かりやすい説明が見つかります。
                    </div>
                    <div style="margin-top: 15px; font-size: 14px; color: #666;">
                        💡 検索結果が表示されない場合は、検索窓に「${word}」と再入力してください。
                    </div>
                </div>
            `;
            
            console.log(`🏫 学研辞書で正しい検索URL使用: "${word}"`);
        }
        
        // AI要約機能（エラーハンドリング強化版）
        async function searchWithAI() {
            const word = document.getElementById('dictInput').value.trim();
            if (!word) {
                alert('調べたい単語を入力してください');
                return;
            }
            
            const resultDiv = document.getElementById('dictResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box result-loading';
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">🤖</div>
                    <div>「${word}」の意味をAIが要約しています...</div>
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">
                        Google検索も同時に開きます
                    </div>
                </div>
            `;
            
            try {
                // Google検索で単語のみ検索（AIによる概要が表示されやすい）
                const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(word)}`;
                window.open(searchUrl, '_blank');
                
                // AI要約を生成してルビ振り（サーバー接続確認付き）
                const aiExplanation = generateDetailedAIExplanation(word);
                
                // サーバー接続確認
                let response;
                try {
                    response = await fetch('/api/ruby', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: aiExplanation })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`サーバーエラー: ${response.status} ${response.statusText}`);
                    }
                } catch (fetchError) {
                    console.error('サーバー接続エラー:', fetchError);
                    
                    // サーバー接続失敗時はルビなしで表示
                    resultDiv.className = 'result-box result-success';
                    resultDiv.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 15px; color: #2d3748; font-size: 1.1em;">
                            🤖 「${word}」のAI要約説明
                        </div>
                        <div style="padding: 20px; background: #fff; border-radius: 10px; border: 2px solid #e2e8f0; line-height: 2.2;">
                            ${aiExplanation}
                        </div>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 14px; color: #856404;">
                            ⚠️ <strong>サーバー接続エラー</strong><br>
                            ルビ振り機能が利用できません。サーバーが起動しているか確認してください。<br>
                            <code>npm start</code> でサーバーを起動してください。
                        </div>
                        <div style="background: #e6fffa; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 14px;">
                            💡 <strong>Google検索のコツ：</strong><br>
                            「${word}」で検索すると、Google AIの「AIによる概要」が表示されることがあります。<br>
                            上の説明と比較して、より詳しい情報を確認してください。
                        </div>
                    `;
                    
                    console.log(`🤖 AI辞書検索完了（ルビなし版): "${word}"`);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    currentDictResult = aiExplanation;
                    
                    resultDiv.className = 'result-box result-success';
                    resultDiv.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 15px; color: #2d3748; font-size: 1.1em;">
                            🤖 「${word}」のAI要約説明（ルビ付き）
                        </div>
                        <div style="padding: 20px; background: #fff; border-radius: 10px; border: 2px solid #e2e8f0; line-height: 2.2;">
                            ${data.output}
                        </div>
                        <div style="background: #e1f5fe; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #03a9f4;">
                            <div style="font-weight: bold; color: #0277bd; margin-bottom: 8px; font-size: 16px;">
                                <ruby>💡<rt></rt></ruby> <ruby>使<rt>つか</rt></ruby>い<ruby>方<rt>かた</ruby>ガイド
                                <button onclick="speakGuide()" style="background: #4fc3f7; color: white; border: none; padding: 5px 10px; border-radius: 15px; margin-left: 10px; cursor: pointer; font-size: 12px;" title="ガイドを読み上げ">
                                    🔊 <ruby>読<rt>よ</rt></ruby>み<ruby>上<rt>あ</rt></ruby>げ
                                </button>
                            </div>
                            <div style="font-size: 14px; line-height: 1.8;">
                                <strong>📖 より<ruby>詳<rt>くわ</rt></ruby>しく<ruby>調<rt>しら</rt></ruby>べるには：</strong><br>
                                • <ruby>新<rt>あたら</rt></ruby>しいタブでGoogle<ruby>検索<rt>けんさく</rt></ruby><ruby>結果<rt>けっか</rt></ruby>が<ruby>開<rt>ひら</rt></ruby>いています<br>
                                • 「AIによる<ruby>概要<rt>がいよう</rt></ruby>」や<ruby>詳細<rt>しょうさい</rt></ruby><ruby>情報<rt>じょうほう</rt></ruby>をご<ruby>確認<rt>かくにん</rt></ruby>ください<br><br>
                                
                                <strong>✨ <ruby>長<rt>なが</rt></ruby>い<ruby>文章<rt>ぶんしょう</rt></ruby>にルビを<ruby>振<rt>ふ</rt></ruby>るには：</strong><br>
                                • Google<ruby>検索<rt>けんさく</rt></ruby><ruby>結果<rt>けっか</rt></ruby>の<ruby>文章<rt>ぶんしょう</rt></ruby>をコピー<br>
                                • <ruby>下<rt>した</rt></ruby>の「ルビ<ruby>振<rt>ふ</rt></ruby>り」セクションに<ruby>貼<rt>は</rt></ruby>り<ruby>付<rt>つ</rt></ruby>け<br>
                                • <ruby>最大<rt>さいだい</rt></ruby>2000<ruby>文字<rt>もじ</rt></ruby>まで<ruby>対応<rt>たいおう</rt></ruby><br><br>
                                
                                <strong>🎯 コツ：</strong><br>
                                • <ruby>複数<rt>ふくすう</rt></ruby>の<ruby>情報<rt>じょうほう</rt></ruby><ruby>源<rt>げん</rt></ruby>で<ruby>確認<rt>かくにん</rt></ruby>すると<ruby>理解<rt>りかい</rt></ruby>が<ruby>深<rt>ふか</rt></ruby>まります
                            </div>
                        </div>
                        <div class="stats">
                            📊 ${data.stats.rubyCount}個のルビを付けて読みやすくしました (${data.stats.processingTime}ms)
                        </div>
                    `;
                    
                    console.log(`🤖 AI辞書検索完了: "${word}"`);
                } else {
                    throw new Error(data.error || 'AI辞書機能でエラーが発生しました');
                }
                
            } catch (error) {
                console.error('AI辞書エラー:', error);
                resultDiv.className = 'result-box result-error';
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">❌</div>
                        <div><strong>エラーが発生しました</strong></div>
                        <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px;">
                            ${error.message}
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #e6fffa; border-radius: 5px; font-size: 14px;">
                            💡 <strong>解決方法:</strong><br>
                            1. サーバーが起動しているか確認: <code>npm start</code><br>
                            2. ブラウザを再読み込み<br>
                            3. Google検索結果をご確認ください
                        </div>
                    </div>
                `;
            }
        }
        
        // より具体的なAI説明生成
        function generateDetailedAIExplanation(word) {
            const explanations = {
                'サグラダファミリア': 'サグラダファミリア（Sagrada Familia）は、スペインのバルセロナにある世界的に有名な教会建築です。建築家アントニ・ガウディが設計し、1882年から建設が始まりました。独特な外観と複雑な装飾で知られ、現在も建設が続いています。完成予定は2026年頃とされており、完成すれば世界で最も建設期間の長い建築物の一つとなります。ユネスコ世界遺産に登録されており、年間数百万人の観光客が訪れる観光名所です。',
                'ガウディ': 'アントニ・ガウディ（1852-1926）は、スペイン・カタルーニャ出身の建築家です。自然からインスピレーションを得た独創的な建築スタイルで知られ、曲線や有機的な形を多用した作品を数多く残しました。代表作にはサグラダファミリア、グエル公園、カサ・ミラなどがあります。モデルニスモ（アール・ヌーヴォー）の代表的な建築家として世界的に評価されています。',
                'バルセロナ': 'バルセロナは、スペイン北東部カタルーニャ州の州都で、同国第二の都市です。地中海に面した港湾都市で、美しい海岸線と温暖な気候で知られています。ガウディの建築群、ピカソ美術館、サッカーチームFCバルセロナなど、芸術・文化・スポーツの中心地として世界的に有名です。毎年多くの観光客が訪れる人気の観光都市でもあります。',
                '十二単': '十二単（じゅうにひとえ）は、平安時代の貴族女性が着用した正装です。実際には十二枚ではなく、複数の着物を重ねて着ることからこの名前が付きました。単（ひとえ）という下着の上に、袿（うちき）と呼ばれる着物を何枚も重ね、最後に唐衣（からぎぬ）と裳（も）を着用します。色の組み合わせは「襲色目（かさねのいろめ）」と呼ばれ、季節や身分によって決められていました。現在でも皇室の重要な儀式で着用されています。',
                '人工知能': '人工知能（じんこうちのう）は、コンピュータが人間の知能を模倣して学習や推論、判断を行う技術です。英語ではArtificial Intelligence、略してAIと呼ばれます。機械学習や深層学習といった手法を使って、大量のデータから規則性やパターンを見つけ出し、予測や分類を自動で行います。画像認識、音声認識、自然言語処理、自動運転など、現代社会の様々な分野で活用されており、私たちの生活を便利にする重要な技術です。',
                '量子コンピュータ': '量子コンピュータは、量子力学の原理を利用した革新的なコンピュータです。従来のコンピュータが0と1の二進法で計算するのに対し、量子コンピュータは量子ビット（キュービット）を使用し、0と1の状態を同時に表現できます。この「重ね合わせ」と「もつれ」という量子現象により、特定の問題に対して従来のコンピュータでは不可能な高速計算が実現可能です。暗号解読、薬物開発、金融計算、気象予測などの分野での応用が期待されており、未来の情報処理技術として注目されています。',
                '光合成': '光合成（こうごうせい）は、植物が太陽の光エネルギーを使って二酸化炭素と水から糖分を作り出す生命現象です。この過程で酸素も同時に生成され、地球上のすべての生物の生存に必要不可欠です。植物の葉にある葉緑体という小さな器官で行われ、クロロフィルという緑色の色素が光を吸収します。光合成により作られた糖分は植物の成長に使われ、また食物連鎖を通じて動物のエネルギー源にもなります。地球の酸素濃度の維持や二酸化炭素の削減にも重要な役割を果たしています。',
                '民主主義': '民主主義（みんしゅしゅぎ）は、国民が政治の決定権を持つ政治制度です。Democracy（デモクラシー）の日本語訳で、「民衆による支配」という意味があります。国民が選挙を通じて代表者を選び、その代表者が国民の意見を政治に反映させる間接民主制が一般的です。多数決の原理に基づきながらも、少数派の権利や意見も尊重することが重要です。言論の自由、集会の自由、報道の自由などの基本的人権が保障され、権力の分立により独裁を防ぎます。現代の多くの国で採用されている政治システムです。',
                '織田信長': '織田信長（おだのぶなが）は、戦国時代を代表する武将で、天下統一の基礎を築いた人物です。1534年に尾張国（現在の愛知県）で生まれ、「天下布武」をスローガンに全国統一を目指しました。桶狭間の戦いで今川義元を破り、その後も革新的な戦術と政策で勢力を拡大しました。楽市楽座による経済政策、鉄砲の積極的活用、石山本願寺との対立など、従来の常識にとらわれない行動で知られています。1582年に本能寺の変で明智光秀に襲われ、49歳で死去しました。豊臣秀吉、徳川家康へと続く天下統一の道筋を作った重要な歴史人物です。'
            };
            
            return explanations[word] || `「${word}」について、より詳しい情報はGoogle検索結果をご確認ください。新しいタブで検索結果が開いています。そこに表示される情報の中で、難しい文章があれば、コピーして下の「ルビ振り」セクションに貼り付けることで、読みやすくできます。一度に最大1000文字まで処理できます。複数の情報源を比較することで、より正確で詳しい知識を得ることができます。`;
        }
        
        // 辞書セクション消去
        function clearDict() {
            document.getElementById('dictInput').value = '';
            document.getElementById('dictResult').style.display = 'none';
            currentDictResult = '';
            console.log('🗑️ 辞書セクション消去');
        }
        
        // 3. ルビ振り機能（エラーハンドリング強化版）
        async function addRuby() {
            const text = document.getElementById('rubyInput').value.trim();
            if (!text) {
                alert('ルビを振りたい文章を入力してください');
                return;
            }
            
            if (text.length > 2000) {
                alert('文章が長すぎます。2000文字以内にしてください。');
                return;
            }
            
            const resultDiv = document.getElementById('rubyResult');
            const rubyBtn = document.getElementById('rubyBtn');
            const copyBtn = document.getElementById('copyBtn');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box result-loading';
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">⚡</div>
                    <div>kuromoji.js でルビを振っています...</div>
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">
                        サーバー接続を確認中...
                    </div>
                </div>
            `;
            rubyBtn.disabled = true;
            copyBtn.style.display = 'none';
            
            try {
                // サーバー接続確認
                let response;
                try {
                    response = await fetch('/api/ruby', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text })
                    });
                } catch (fetchError) {
                    console.error('サーバー接続エラー:', fetchError);
                    throw new Error(`サーバーに接続できません。サーバーが起動しているか確認してください。

解決方法:
1. terminalで 'npm start' を実行
2. サーバーが http://localhost:3000 で起動していることを確認
3. ブラウザを再読み込み

エラー詳細: ${fetchError.message}`);
                }
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'レスポンス取得失敗');
                    throw new Error(`サーバーエラー: ${response.status} ${response.statusText}\n詳細: ${errorText}`);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    throw new Error('サーバーからの応答が不正です。JSON解析に失敗しました。');
                }
                
                if (data.success) {
                    currentRubyResult = data.output;
                    
                    resultDiv.className = 'result-box result-success';
                    resultDiv.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 15px; color: #2d3748;">
                            ✨ ルビ振り完了！
                        </div>
                        <div style="padding: 20px; background: #fff; border-radius: 10px; border: 2px solid #e2e8f0; line-height: 2.2;">
                            ${data.output}
                        </div>
                        <div class="stats">
                            📊 ${data.stats.inputLength}文字 → ${data.stats.tokens}トークン → ${data.stats.rubyCount}個のルビを付与 (${data.stats.processingTime}ms)
                        </div>
                    `;
                    
                    copyBtn.style.display = 'flex';
                    console.log(`✨ ルビ振り完了: ${data.stats.tokens}トークン`);
                } else {
                    throw new Error(data.error || 'ルビ振り処理でエラーが発生しました');
                }
                
            } catch (error) {
                console.error('ルビ振りエラー:', error);
                resultDiv.className = 'result-box result-error';
                resultDiv.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="font-size: 1.2em; margin-bottom: 15px; color: #c53030;">
                            ❌ ルビ振りエラー
                        </div>
                        <div style="background: #fed7d7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>エラー内容:</strong><br>
                            ${error.message}
                        </div>
                        <div style="background: #e6fffa; padding: 15px; border-radius: 8px;">
                            <strong>💡 解決方法:</strong><br>
                            1. ターミナルで <code>npm start</code> を実行<br>
                            2. サーバーが起動したらブラウザを再読み込み<br>
                            3. この画面で「ルビを付ける」ボタンを再度押す
                        </div>
                    </div>
                `;
            } finally {
                rubyBtn.disabled = false;
            }
        }
        
        // ルビセクション消去
        function clearRuby() {
            document.getElementById('rubyInput').value = '';
            document.getElementById('rubyResult').style.display = 'none';
            document.getElementById('copyBtn').style.display = 'none';
            currentRubyResult = '';
            console.log('🗑️ ルビセクション消去');
        }
        
        // 結果をコピー（Word貼り付け対応・フォントサイズ調整版）
        function copyResult() {
            if (!currentRubyResult) {
                alert('コピーする結果がありません');
                return;
            }
            
            try {
                // Word用に最適化されたHTMLを生成（UDフォント + 文字16px、ルビ8px）
                const optimizedHTML = `
                    <div style="font-family: 'BIZ UDPゴシック', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif; font-size: 16px; line-height: 2.2;">
                        ${currentRubyResult.replace(/<ruby>/g, '<ruby style="font-size: 16px;">').replace(/<rt>/g, '<rt style="font-size: 8px; color: #666;">')}
                    </div>
                `;
                
                // プレーンテキスト版（ルビなし）
                const plainText = currentRubyResult.replace(/<[^>]*>/g, '');
                
                // クリップボードAPIを使用（HTMLとテキスト両方をコピー）
                if (navigator.clipboard && navigator.clipboard.write) {
                    const clipboardItem = new ClipboardItem({
                        'text/html': new Blob([optimizedHTML], { type: 'text/html' }),
                        'text/plain': new Blob([plainText], { type: 'text/plain' })
                    });
                    
                    navigator.clipboard.write([clipboardItem]).then(() => {
                        showCopySuccess('Word最適化版');
                        console.log('📋 Word最適化HTML + テキストをコピー完了');
                    }).catch(err => {
                        console.log('HTML+テキストコピー失敗、フォールバック実行');
                        fallbackCopy();
                    });
                } else {
                    // フォールバック: テキストのみコピー
                    fallbackCopy();
                }
                
            } catch (error) {
                console.error('コピーエラー:', error);
                alert('コピーに失敗しました');
            }
        }
        
        // フォールバック: テキストのみコピー
        function fallbackCopy() {
            const textArea = document.createElement('textarea');
            textArea.value = currentRubyResult.replace(/<[^>]*>/g, ''); // HTMLタグを除去
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showCopySuccess('テキスト版');
            console.log('📋 テキストをコピー完了（フォールバック）');
        }
        
        // コピー成功通知（詳細版）
        function showCopySuccess(type) {
            const notification = document.createElement('div');
            notification.className = 'copy-success';
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">📋 コピー完了！</div>
                <div style="font-size: 13px;">
                    ${type}をコピーしました<br>
                    Wordに貼り付けると文字16px、ルビ8pxで表示されます
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 4000);
        }
        
        // キーボードショートカット
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'Enter':
                        if (document.activeElement.id === 'searchInput') {
                            e.preventDefault();
                            googleSearch();
                        } else if (document.activeElement.id === 'dictInput') {
                            e.preventDefault();
                            searchWordMeaning();
                        } else if (document.activeElement.id === 'rubyInput') {
                            e.preventDefault();
                            addRuby();
                        }
                        break;
                    case 'c':
                        if (currentRubyResult && document.activeElement.id === 'rubyInput') {
                            e.preventDefault();
                            copyResult();
                        }
                        break;
                }
            }
        });
        
        // ページ読み込み完了時
        window.addEventListener('load', () => {
            console.log('📚 まなびの窓口 - 準備完了！');
            console.log('⌨️  ショートカット: Ctrl+Enter=実行, Ctrl+C=コピー');
            
            // 最初の入力欄にフォーカス
            document.getElementById('searchInput').focus();
        });
    </script>
</body>
</html>
